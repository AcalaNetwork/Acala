name: Release Notes

env:
  SUBWASM_VERSION: 0.13.2
  SRTOOL_TAG: 1.53.0-0.9.16
  NETWORK: karura
  SCOPE: full

on:
  workflow_dispatch:
    inputs:
      network:
        description: Network [mandala | karura | acala]
        default: karura
        required: true
      scope:
        description: Release scope [client | runtime | full]
        default: full
        required: true
  push:
    # tags:
    #   - "*"

jobs:
  release-notes:
    name: Build release note
    runs-on: ubuntu-latest
    # env:
    #   NETWORK: ${{ github.event.inputs.network }}
    #   SCOPE: ${{ github.event.inputs.scope }}
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive

      - name: Install toolchain
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: nightly-2021-06-17
          components: rustfmt
          target: wasm32-unknown-unknown
          default: true

      - name: Srtool build
        id: srtool_build
        uses: chevdor/srtool-actions@v0.3.0
        with:
          chain: ${{ env.NETWORK }}
          tag: ${{ github.event.inputs.srtool_tag || env.SRTOOL_TAG }}

      - name: Summary
        run: |
          echo '${{ steps.srtool_build.outputs.json }}' | jq > ${{ env.NETWORK }}-srtool-digest.json
          cat ${{ env.NETWORK }}-srtool-digest.json
          echo "Runtime location: ${{ steps.srtool_build.outputs.wasm }}"

      # We now get extra information thanks to subwasm,
      - name: Install subwasm ${{ env.SUBWASM_VERSION }}
        run: |
          wget https://github.com/chevdor/subwasm/releases/download/v${{ env.SUBWASM_VERSION }}/subwasm_linux_amd64_v${{ env.SUBWASM_VERSION }}.deb
          sudo dpkg -i subwasm_linux_amd64_v${{ env.SUBWASM_VERSION }}.deb
          subwasm --version

      - name: Extract the metadata
        run: |
          subwasm meta ${{ steps.srtool_build.outputs.wasm }}
          subwasm --json meta ${{ steps.srtool_build.outputs.wasm }} > ${{ env.NETWORK }}-metadata.json
      - name: Check the metadata diff
        run: |
          subwasm get wss://karura-rpc-2.aca-api.network/ws --output runtime_mainnet.wasm
          subwasm diff ${{ steps.srtool_build.outputs.wasm }} runtime_mainnet.wasm | tee ${{ env.NETWORK }}-diff.txt


      - name: Generate note
        id: generate-note
        uses: AcalaNetwork/acala-release-note-action@master
        with:
          scope: ${{ env.SCOPE }}
          network: ${{ env.NETWORK }}
          template: .github/release-template.hbs
          srtool_details: ${{ env.NETWORK }}-srtool-digest.json
          subwasm_info: ${{ env.NETWORK }}-diff.txt
          tag: 1.5.0
          previous_tag: 1.4.3

      - name: Archive Release Note
        uses: actions/upload-artifact@v2
        with:
          name: ${{ env.NETWORK }}-release-note
          path: |
            ${{ steps.generate-note.outputs.release-note }}
 
