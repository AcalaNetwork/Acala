# This is a basic workflow to help you get started with Actions
name: publish solidity package

# Controls when the action will run.
on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      commitMessage:
        description: 'commit message'
        required: true
        default: 'update tokens and publish it'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
        with:
          submodules: recursive
      - uses: actions/setup-node@v2
        with:
          node-version: '14.x'
          registry-url: 'https://registry.npmjs.org'
      - name: publish solidity package
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          set -x
          echo running on branch ${GITHUB_REF##*/}
          git config --global user.name "Github Actions"
          git config --global user.email "Github Actions"
          branch="update-predeploy-contracts-$(date "+%Y%m%d%H%M%y")"
          git checkout -b "$branch"
          cd predeploy-contracts
          git checkout master
          git pull
          cd ..
          make generate-tokens
          cd predeploy-contracts
          if [ -z "$(git status --porcelain)" ]
          then
              echo "nothing to update."
          else
              git commit -am "${{ github.event.inputs.commitMessage }}"
          fi
          cd ..
          cd predeploy-contracts/contracts
          yarn run prepare
          yarn publish --patch --access public
          git config --unset-all http.https://github.com/.extraheader
          git push "https://${{ secrets.GH_PAT }}@github.com/AcalaNetwork/predeploy-contracts.git" HEAD:master
          cd ../..
          git commit -am "${{ github.event.inputs.commitMessage }}"
          git push -u "https://${{ secrets.GH_PAT }}@github.com/AcalaNetwork/Acala.git" "$branch"
          hub pull-request -m "${{ github.event.inputs.commitMessage }}"
